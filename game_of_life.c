#include <gb/gb.h>
#include "background.c"

/*
BG: 20 tiles wide, 18 high
*/

#define HEIGHT 18
#define WIDTH 20

#define ALIVE 0x00
#define DEAD 0x01

void setup();
void loop_over_cells();
void show_board();
void swap_boards();
void apply_rule();
UBYTE live_neighbours();

unsigned char board1[] =
{
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x00,0x00,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};
unsigned char board2[WIDTH * HEIGHT];

unsigned char* current_board = (unsigned char*) &board1;
unsigned char* next_board = (unsigned char*) &board2;

void main()
{
    setup();
    while (1)
    {
        show_board();
        loop_over_cells();
        swap_boards();
    }
}

void setup()
{
    UWORD i = 0;
    while(i != WIDTH * HEIGHT) {
        // board1[i] = 0;
        board2[i] = 0;
        i++;
    }
    DISPLAY_ON;
    set_bkg_data(0, 10, backgrounds);
    SHOW_BKG;
}

UWORD y;
UWORD x;
UWORD index;
void loop_over_cells()
{
    y = 0;
    x = 0;
    while(1) {
        index = x + y * WIDTH;
        apply_rule();

        if(x == WIDTH - 1) {
            if(y == HEIGHT - 1) {
                break;
            } else {
                x = 0;
                y++;
            }
        } else {
            x++;
        }
    }
}

void swap_boards() {
    if(current_board == (unsigned char*) &board1) {
        current_board = (unsigned char*) &board2;
        next_board = (unsigned char*) &board1;
    } else {
        current_board = (unsigned char*) &board1;
        next_board = (unsigned char*) &board2;
    }
}

void show_board()
{
    wait_vbl_done();
    set_bkg_tiles(0, 0, WIDTH, HEIGHT, current_board);
}

void apply_rule() {
    UBYTE live_neighbors = live_neighbours();
        // next_board[index] = 1 + live_neighbors;
    if (live_neighbors == 3 || (current_board[index] && live_neighbors == 2)) {
        next_board[index] = 0x01;
    } else {
        next_board[index] = 0x00;
    }
}

UWORD neighbor_index;
UBYTE live_neighbours() {
    UBYTE results = 0;

    //top left
    if(x != 0 && y != 0) {
        neighbor_index = ((y - 1) * WIDTH) + (x - 1);
        if(current_board[neighbor_index] != 0) {
            results++;
        }
    }
    //top middle
    if(y != 0) {
        neighbor_index = ((y - 1) * WIDTH) + x;
        if(current_board[neighbor_index] != 0) {
            results++;
        }
    }
    //top right
    if ((x != (WIDTH - 1)) && y != 0) {
        neighbor_index = ((y - 1) * WIDTH) + (x + 1);
        if(current_board[neighbor_index] != 0) {
            results++;
        }
    }
    
    //middle left
    if(x != 0) {
        neighbor_index = (y * WIDTH) + (x - 1);
        if(current_board[neighbor_index] != 0) {
            results++;
        }
    }

    //middle right
    if(x != WIDTH - 1) {
        neighbor_index = (y * WIDTH) + (x + 1);
        if(current_board[neighbor_index] != 0) {
            results++;
        }
    }

    if(x != 0 && (y != (HEIGHT - 1))) {
        neighbor_index = ((y + 1) * WIDTH) + (x - 1); 
        if(current_board[neighbor_index] != 0) {
            results++;
        }
    }

    if(y != (HEIGHT - 1)) {
        neighbor_index = (y + 1) * WIDTH + x;
        if(current_board[neighbor_index] != 0) {
            results++;
        }
    }

    if((x != (WIDTH - 1)) && (y != (HEIGHT -1))) {
        neighbor_index = ((y + 1) * WIDTH) + (x + 1);
        if(current_board[neighbor_index] != 0) {
            results++;
        }
    }

    return results;
}
